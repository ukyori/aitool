# 株主優待通知システム - 要件定義

## 概要

96ut.com から「翌月分」の株主優待銘柄一覧を取得し、権利日の約40日前に自動でメール通知するシステム。

## 取得元

- **URL**: https://96ut.com/yuutai/list.php
- **データ形式**: HTML（スクレイピング）

## 取得フロー

### 1. term（権利日）一覧の取得

- `list.php` 内の `input[type="radio"]` から権利日term一覧を取得
- 各ラジオボタンの `value` 属性が term 値
- ラベル（例：「1月20」）は近傍テキストから取得

### 2. termごとの銘柄一覧取得

- URL: `list.php?term={term}&days=0&gdate={YYYY-MM-DD}&key_y=y`
- ページ内の「権利日：YYYY年MM月DD日」から正確な権利日を取得
- 銘柄一覧テーブルをパース

## 通知条件

| 項目 | 値 |
|------|-----|
| 対象期間 | 権利日の **40日前 ±1日** |
| 実行頻度 | 1日1回（例：07:30 JST） |
| 重複防止 | Workflow Static Data で送信済み権利日を記録 |

## 必須取得列

| 列名 | 説明 |
|------|------|
| 権利日 | YYYY-MM-DD形式 |
| 銘柄コード | 4桁コード |
| 銘柄名 | 企業名 |
| 貸借 | 貸借銘柄区分 |
| 対策(規制等) | 信用規制情報 |
| 最逆(最大逆日歩) | 最大逆日歩情報 |

## メール仕様

### 形式

- **HTML**: テーブル形式（`border=1`相当）
- **TSV**: `<pre>` タグ内にタブ区切りテキスト（コピペ用）

### 件名

```
[株主優待] YYYY-MM-DD 権利日 - N件
```

### 本文構成

1. 対象権利日
2. 取得日時（JST）
3. 取得元URL
4. 件数
5. TSVのコピペ方法説明
6. HTMLテーブル
7. TSVデータ（`<pre>`内）

### 複数権利日対応

- 1メールで複数権利日が対象になる場合、セクション分けで表示

## 重複送信防止

- **方式**: n8n Workflow Static Data
- **記録形式**: `sent_dates[rights_date] = sent_at_timestamp`
- **動作**: 送信済み権利日はスキップ

## 技術制約

### スクレイピング

- サーバー負荷軽減のため、termごとに **1〜2秒のWait** を入れる
- User-Agent を適切に設定
- HTMLパースは正規表現ベース（外部ライブラリ不使用）

### n8n

- Codeノード: JavaScript（Node.js標準のみ、外部npm不可）
- Gmail送信: n8n Gmailノード（OAuth認証、Credentialはコード外）

## セキュリティ

- 秘密情報（メールアドレス、パスワード、OAuth、APIキー）は **リポジトリに含めない**
- Credentialは n8n の設定画面で管理

## エラーハンドリング

- パース失敗時は、どの抽出処理で失敗したかを明示した `throw`
- n8n Executionsログで確認可能な構造

## 拡張性

- 必須列のみ確実に取得する最小構成
- 追加列は後から拡張可能な構造
